<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ekklo Â· Connected in Spirit</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap');
        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background: radial-gradient(circle at 10% 30%, #0A1922, #0B1A26);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            color-scheme: light;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }

        /* ---------- premium spiritual tokens ---------- */
        .chat-container { height: calc(100vh - 200px); overflow-y: auto; scrollbar-width: thin; scrollbar-color: rgba(20, 184, 166, 0.5) rgba(10, 30, 40, 0.1); }
        .chat-container::-webkit-scrollbar { width: 5px; }
        .chat-container::-webkit-scrollbar-track { background: rgba(15, 30, 40, 0.2); border-radius: 20px; margin-block: 8px; }
        .chat-container::-webkit-scrollbar-thumb { background: #14B8A6; border-radius: 20px; opacity: 0.7; }

        /* ===== CHAT CARDS - MODERN WHATSAPP STYLE ===== */
.chat-card {
    transition: all 0.2s cubic-bezier(0.2, 0, 0, 1);
    border-radius: 1rem;
    margin-bottom: 2px;
    width: 100%;
}
.chat-card:hover {
    background-color: rgba(255,255,255,0.06);
    backdrop-filter: blur(4px);
    transform: translateX(4px);
}
.chat-card.active {
    background: rgba(20, 184, 166, 0.08);
    border-left: 4px solid #14B8A6;
    border-radius: 1rem 0.75rem 0.75rem 1rem;
}
.unread-badge {
    background: linear-gradient(145deg, #0F766E, #14B8A6);
    box-shadow: 0 4px 10px rgba(20,184,166,0.25);
    font-weight: 600;
    padding: 0.2rem 0.6rem;
    border-radius: 9999px;
    color: white;
    font-size: 0.7rem;
    min-width: 1.5rem;
    display: inline-flex;
    align-items: center;
    justify-content: center;
}
.timestamp {
    font-size: 0.7rem;
    font-weight: 400;
    color: rgba(255,255,255,0.45);
}
.last-message {
    color: rgba(255,255,255,0.6);
    font-size: 0.8rem;
    line-height: 1.25;
    max-width: 180px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
.contact-name {
    font-weight: 600;
    color: rgba(255,255,255,0.9);
    letter-spacing: -0.01em;
}

/* Make user-list vertical, not horizontal */
#user-list {
    display: flex !important;
    flex-direction: column !important;
    gap: 0.25rem !important;
    width: 100% !important;
    padding: 0.5rem 0.25rem !important;
    max-height: 100% !important;
    overflow-y: auto !important;
}

/* Override any horizontal styles */
#user-list > div {
    width: 100% !important;
    min-width: 100% !important;
    max-width: 100% !important;
}

        /* Toggle between user list and chat */
#user-list {
    display: block !important;
}

#chat-area {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden; /* Important for containing the chat */
    position: relative;
    border-radius: 1.5rem;
}

#chat-area.active {
    display: flex !important;
    flex-direction: column;
}

/* Call controls styling */
#call-modal .relative {
    position: relative;
    width: 100%;
}

#call-timer {
    position: absolute;
    top: 1rem;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0,0,0,0.5);
    backdrop-filter: blur(8px);
    padding: 0.5rem 1rem;
    border-radius: 9999px;
    font-family: monospace;
    font-size: 0.875rem;
    color: white;
    border: 1px solid rgba(255,255,255,0.1);
    z-index: 40;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}

#local-video.enlarged {
    width: 160px !important;
    height: 240px !important;
    transition: all 0.3s ease;
}

#local-video {
    cursor: move;
    transition: all 0.3s ease;
    cursor: pointer;
    user-select: none;
    -webkit-user-select: none;
    touch-action: none; 
    z-index: 30;
}

#local-video:hover {
    border-color: #14B8A6;
    transform: scale(1.02);
}

/* Control buttons animation */
#call-modal button {
    transition: all 0.2s ease;
}

#call-modal button:active {
    transform: scale(0.95);
}

/* Fullscreen styles */
#call-modal:-webkit-full-screen .relative {
    width: 100vw;
    height: 100vh;
    max-width: none;
    border-radius: 0;
}

#call-modal:fullscreen .relative {
    width: 100vw;
    height: 100vh;
    max-width: none;
    border-radius: 0;
}

/* When chat is active, hide user list */
body.chat-active #user-list {
    display: none !important;
}

body.chat-active #chat-area {
    display: flex !important;
}
        
        /* ----- message bubbles â€“ serene, clean, elegant ----- */
        .message-bubble {
            max-width: 80%;
            padding: 12px 18px;
            border-radius: 22px;
            position: relative;
            box-shadow: 0 2px 8px rgba(0,0,0,0.02), 0 1px 2px rgba(0,0,0,0.02);
            transition: transform 0.2s ease, box-shadow 0.25s ease;
            backdrop-filter: blur(2px);
            word-break: break-word;
            line-height: 1.45;
            font-size: 0.95rem;
        }
        .message-bubble:hover {
            box-shadow: 0 12px 24px -8px rgba(20,184,166,0.12), 0 4px 8px rgba(0,0,0,0.02);
            transform: scale(1.01);
        }
        .sent {
            background: linear-gradient(145deg, #0F766E, #14B8A6);
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 6px;
            border-top-right-radius: 22px;
            border-top-left-radius: 22px;
            border-bottom-left-radius: 22px;
            box-shadow: 0 6px 14px rgba(20,184,166,0.2);
        }
        .received {
            background: rgba(255,255,255,0.85);
            backdrop-filter: blur(12px);
            color: #0F172A;
            align-self: flex-start;
            border-bottom-left-radius: 6px;
            border-top-left-radius: 22px;
            border-top-right-radius: 22px;
            border-bottom-right-radius: 22px;
            border: 0.5px solid rgba(255,255,255,0.6);
            box-shadow: 0 4px 12px rgba(0,0,0,0.02);
        }

        /* ----- status rings with divine glow ----- */
        .status-ring {
            padding: 2px;
            border-radius: 50%;
            transition: all 0.2s ease;
            box-shadow: 0 0 0 2px rgba(20,184,166,0);
        }
        .status-ring:hover {
            transform: scale(1.05);
            box-shadow: 0 0 0 3px rgba(20,184,166,0.25);
        }

        /* ----- glassmorphism â€“ modern faith-tech ----- */
        .glass-panel {
            background: rgba(10, 30, 40, 0.6);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 0.5px solid rgba(255,255,255,0.1);
            box-shadow: 0 12px 40px -12px rgba(0,0,0,0.3);
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }

        /* status viewer â€“ immersive & pure */
        #status-viewer {
            background: radial-gradient(circle at 30% 30%, #0A1A1F, #030812);
        }
        .status-progress-fill { background: #14B8A6; box-shadow: 0 0 8px #14B8A6; }

        /* ----- modal elegance ----- */
        .modal-overlay {
            backdrop-filter: blur(12px);
            background: rgba(8, 20, 26, 0.8);
        }
        .modal-content {
            background: rgba(18, 35, 45, 0.9);
            backdrop-filter: blur(24px);
            border: 0.5px solid rgba(255,255,255,0.06);
            box-shadow: 0 30px 60px -20px rgba(0,20,20,0.6);
            animation: scaleUp 0.3s cubic-bezier(0.16,1,0.3,1);
            border-radius: 32px;
            color: white;
        }
        @keyframes scaleUp {
            from { opacity: 0; transform: scale(0.94) translateY(10px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }

        /* premium input */
        .glass-input {
            background: rgba(15, 30, 40, 0.55);
            backdrop-filter: blur(18px);
            border: 0.6px solid rgba(255,255,255,0.08);
            transition: all 0.2s;
            color: white;
        }
        .glass-input:focus {
            border-color: #14B8A6;
            background: rgba(20, 45, 55, 0.7);
            box-shadow: 0 0 0 3px rgba(20,184,166,0.1);
        }

        /* active glow for avatars */
        .active-glow {
            box-shadow: 0 0 0 3px #14B8A6, 0 0 20px #14B8A640;
        }

        /* subtle gradient backgrounds */
        .bg-soft-radial {
            background: radial-gradient(ellipse at top, #0B1F28, #0A1921);
        }

        /* recording pulse â€“ gentle */
        .recording-pulse { animation: pulse-teal 1.5s infinite; color: #14B8A6; }
        @keyframes pulse-teal {
            0% { transform: scale(1); text-shadow: 0 0 0 #14B8A6; }
            50% { transform: scale(1.1); text-shadow: 0 0 12px #14B8A6; }
            100% { transform: scale(1); text-shadow: 0 0 0 #14B8A6; }
        }

    /* Add to your style section */
#reply-preview {
    animation: slideUp 0.2s ease;
}

@keyframes slideUp {
    from { transform: translateY(10px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}

#message-context-menu {
    animation: fadeIn 0.1s ease;
}

@keyframes fadeIn {
    from { opacity: 0; transform: scale(0.95); }
    to { opacity: 1; transform: scale(1); }
}
    </style>
</head>
<body class="antialiased">

<div id="app" class="max-w-5xl mx-auto w-full h-full flex flex-col my-2 px-1.5 relative">
    
    <!-- â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ HEADER â€“ EKKLO SACRED â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ -->
    <header class="glass-panel text-white px-3 sm:px-6 py-3 sm:py-4 flex justify-between items-center z-30 rounded-[24px] sm:rounded-[32px] mb-2 shadow-2xl border border-white/10 mx-0.5">
        <div class="flex items-center gap-2 sm:gap-4 min-w-0 flex-1">
            <!-- YOUR AVATAR (always visible) -->
            <div id="my-avatar" onclick="openSettings()" class="w-11 h-11 rounded-full bg-gradient-to-br from-teal-400/30 to-emerald-500/30 flex items-center justify-center font-bold text-lg cursor-pointer ring-2 ring-white/20 ring-offset-2 ring-offset-[#0B1F28] transition hover:ring-teal-300/70">
                M
            </div>
            <!-- CONTACT AVATAR (visible when chat active) -->
            <div id="contact-avatar-container" class="hidden">
                <div id="contact-avatar" class="w-9 h-9 sm:w-11 sm:h-11 rounded-full bg-gradient-to-br from-teal-400/30 to-emerald-500/30 flex items-center justify-center font-bold text-base sm:text-lg cursor-pointer ring-2 ring-white/20 ring-offset-2 ring-offset-[#0B1F28] transition hover:ring-teal-300/70 flex-shrink-0"></div>
            </div>
            <div class="leading-tight min-w-0 flex-1">
                <h1 id="chat-header-name" class="font-bold text-base sm:text-xl tracking-tight text-white/90 flex items-center gap-1 sm:gap-2 flex-wrap">
                    <span class="bg-gradient-to-r from-teal-300 to-emerald-200 bg-clip-text text-transparent">Ekklo</span>
                    <span class="text-[6px] sm:text-[8px] font-light px-1.5 sm:px-2 py-0.5 bg-white/10 rounded-full text-teal-100/80 border border-white/5 whitespace-nowrap">connected in spirit</span>
                </h1>
                <p id="chat-header-status" class="text-[9px] sm:text-[11px] font-light text-white/50 mt-0.5 tracking-wide">select a contact</p>
            </div>
        </div>
        <div class="flex gap-0.5 sm:gap-1 mr-0 sm:mr-2 flex-shrink-0">
         <button onclick="initiateCall(true)" class="p-1.5 sm:p-2 text-white/80 hover:text-white"><i class="fas fa-video text-sm sm:text-base"></i></button>
         <button onclick="initiateCall(false)" class="p-1.5 sm:p-2 text-white/80 hover:text-white"><i class="fas fa-phone text-sm sm:text-base"></i></button>
        <button onclick="handleLogout()" class="opacity-60 hover:opacity-100 p-1.5 sm:p-2 rounded-full hover:bg-white/5 transition-all duration-200">
            <i class="fas fa-sign-out-alt text-white/80 text-sm sm:text-lg"></i>
        </button>
        </div>
    </header>

    <!-- â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ LOGIN â€“ PREMIUM CARD â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ -->
    <div id="auth-screen" class="fixed inset-0 z-50 flex items-center justify-center p-6" style="background: radial-gradient(125% 125% at 50% 10%, #0A1F28, #071016);">
        <div class="w-full max-w-md glass-panel rounded-[40px] p-10 text-center border border-white/5 shadow-[0_30px_50px_-20px_rgba(0,0,0,0.8)]">
            <div class="flex justify-center mb-6">
                <div class="w-20 h-20 rounded-full bg-gradient-to-br from-teal-400/20 to-emerald-400/20 flex items-center justify-center border border-white/20 backdrop-blur-lg">
                     <img src="ekklo.png" alt="Logo" class="w-full h-full object-cover mb-3">
                </div>
            </div>
            <h2 class="text-4xl font-bold text-white tracking-tight mb-2">Ekklo</h2>
            <p class="text-teal-200/60 text-sm mb-10 font-light">sacred Â· global Â· communion</p>
            <div class="space-y-4">
                <input type="email" id="login-email" placeholder="your email" class="w-full p-4 bg-white/5 backdrop-blur-md border border-white/10 rounded-2xl outline-none text-white placeholder:text-white/40 focus:ring-2 focus:ring-teal-400/50 transition">
                <input type="password" id="login-pass" placeholder="password" class="w-full p-4 bg-white/5 backdrop-blur-md border border-white/10 rounded-2xl outline-none text-white placeholder:text-white/40 focus:ring-2 focus:ring-teal-400/50 transition">
                <button onclick="handleLogin()" class="w-full bg-gradient-to-r from-teal-500 to-emerald-500 text-white font-bold py-4 rounded-2xl shadow-xl shadow-teal-500/20 hover:shadow-teal-500/40 hover:scale-[1.02] transition-all duration-300 text-lg tracking-wide">
                    enter Ekklo
                </button>
            </div>
        </div>
    </div>

    <!-- â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ MODAL â€“ CUSTOM (TEAL ACCENTS) â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ -->
    <div id="custom-modal" class="modal-overlay fixed inset-0 hidden items-center justify-center" style="z-index: 9999;">
        <div class="modal-content w-[90%] max-w-sm p-8 text-center">
            <div id="modal-icon" class="text-5xl mb-5 text-teal-400"></div>
            <h3 id="modal-title" class="text-2xl font-bold text-white mb-2"></h3>
            <p id="modal-text" class="text-white/70 mb-8 text-sm"></p>
            <button onclick="closeModal()" class="w-full bg-gradient-to-r from-teal-600 to-teal-500 text-white font-bold py-3.5 rounded-xl shadow-lg hover:shadow-teal-500/30 transition">
                amen
            </button>
        </div>
    </div>

    <!-- â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ SETTINGS â€“ SERENE MODAL â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ -->
    <div id="settings-modal" class="modal-overlay hidden fixed inset-0 z-[1000] flex items-center justify-center">
        <div class="bg-[#0F1F28]/90 backdrop-blur-2xl w-full max-w-sm rounded-3xl overflow-hidden border border-white/10 shadow-2xl">
            <div class="bg-gradient-to-b from-teal-900/50 to-transparent p-7 text-center border-b border-white/5">
                <div id="settings-avatar-preview" class="flex justify-center mb-3"></div>
                <h3 class="font-bold text-xl text-white/90">sacred profile</h3>
            </div>
            <div class="p-7 space-y-6">
                <div>
                    <label class="text-[11px] font-bold uppercase tracking-wider text-teal-300/70">profile icon</label>
                    <input type="file" id="pic-input" class="hidden" accept="image/*" onchange="uploadPhoto()">
                    <button onclick="document.getElementById('pic-input').click()" class="w-full mt-2 bg-white/5 py-3 rounded-xl text-sm font-semibold text-white/80 border border-white/5 hover:bg-teal-500/20 transition">
                        <i class="fas fa-cloud-upload-alt mr-2"></i> upload new
                    </button>
                </div>
                <div>
                    <label class="text-[11px] font-bold uppercase tracking-wider text-teal-300/70">display name</label>
                    <input type="text" id="settings-name-input" class="w-full bg-transparent border-b-2 border-white/10 py-2 outline-none text-white placeholder:text-white/30 focus:border-teal-400 transition">
                </div>
                <div class="flex gap-3 pt-4">
                    <button onclick="closeSettings()" class="flex-1 py-3.5 text-white/70 font-bold rounded-xl hover:bg-white/5 transition">cancel</button>
                    <button onclick="saveProfile()" class="flex-1 py-3.5 bg-gradient-to-r from-teal-600 to-emerald-600 text-white rounded-xl font-bold shadow-lg shadow-teal-500/20 hover:scale-[1.02] transition">
                        bless
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ STATUS MODAL â€“ PEACEFUL â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ -->
    <div id="status-modal" class="modal-overlay hidden items-center justify-center">
        <div class="modal-content w-[90%] max-w-md p-8">
            <div class="flex justify-between items-center mb-5">
                <h3 class="text-xl font-semibold text-white/90">share a prayer</h3>
                <button onclick="closeStatusModal()" class="text-white/40 hover:text-white transition"><i class="fas fa-times text-2xl"></i></button>
            </div>
            <textarea id="status-input-text" placeholder="What's on your spirit?" class="w-full p-4 bg-white/5 border border-white/10 rounded-2xl resize-none outline-none text-white placeholder:text-white/30 focus:ring-2 focus:ring-teal-400/60 mb-5" rows="3"></textarea>
            <div class="flex flex-col gap-3">
                <button onclick="submitStatus(false)" class="w-full bg-white/10 backdrop-blur text-white font-bold py-3.5 rounded-xl hover:bg-white/20 transition border border-white/5">
                    <i class="fas fa-feather-alt mr-2"></i> text only
                </button>
                <button onclick="document.getElementById('status-file-hidden').click()" class="w-full bg-gradient-to-r from-teal-600 to-emerald-600 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-teal-500/20 hover:shadow-teal-500/30 transition">
                    <i class="fas fa-camera-retro mr-2"></i> upload photo/video
                </button>
            </div>
            <input type="file" id="status-file-hidden" class="hidden" accept="image/*,video/*" onchange="submitStatus(true)">
        </div>
    </div>

    <!-- â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ STATUS VIEWER â€“ DIVINE â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ -->
    <div id="status-viewer" class="hidden fixed inset-0 z-[1100] flex-col items-center justify-center" style="background: radial-gradient(circle at 30% 40%, #041016, #02090C);">
        <div class="status-progress-container absolute top-4 left-4 right-4 flex gap-1.5 z-30">
            <div class="status-progress-bar h-1 flex-1 bg-white/10 rounded-full overflow-hidden backdrop-blur-sm">
                <div id="status-fill" class="status-progress-fill h-full w-0 rounded-full bg-teal-400 shadow-[0_0_10px_#14B8A6]"></div>
            </div>
        </div>
        <div class="absolute top-8 left-8 flex items-center gap-4 text-white">
            <div id="viewer-avatar" class="w-10 h-10 rounded-full ring-2 ring-teal-400/60 ring-offset-2 ring-offset-black/40"></div>
            <div>
                <p id="viewer-name" class="font-bold text-lg"></p>
                <p id="viewer-time" class="text-xs text-white/50"></p>
            </div>
        </div>
        <div class="absolute top-8 right-8 text-white/70 text-3xl cursor-pointer hover:text-white transition z-30" onclick="closeStatus()">
            <i class="fas fa-times-circle"></i>
        </div>
        <div id="status-content" class="max-w-2xl w-full p-8 text-center text-white flex flex-col items-center justify-center"></div>
        <div class="absolute bottom-12 flex flex-col items-center text-white/80 bg-black/20 backdrop-blur-xl px-7 py-3 rounded-full border border-white/5">
            <div class="flex items-center gap-2 text-sm">
                <i class="fas fa-eye text-teal-300 text-xs"></i>
                <span id="viewer-views" class="font-bold">0</span>
            </div>
            <p id="viewed-by-names" class="text-[10px] opacity-60 mt-0.5 italic"></p>
        </div>
    </div>

    <!-- â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ MAIN CHAT â€“ SACRED SPACE â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ -->
    <main id="main-chat" class="flex-1 flex flex-col hidden overflow-hidden relative rounded-3xl">
        
        <!-- STATUS ROW + USER LIST CONTAINER -->
        <div class="flex flex-col overflow-hidden h-full">
            <!-- status row - always visible -->
            <div class="bg-white/5 backdrop-blur-2xl border-b border-white/5 px-2 sm:px-5 py-2 sm:py-4 flex gap-3 sm:gap-6 overflow-x-auto no-scrollbar items-center shrink-0">
                <!-- add status â€“ premium glass card -->
                <div class="flex flex-col items-center min-w-[60px] sm:min-w-[80px] cursor-pointer group" onclick="openStatusModal()">
                    <div class="w-12 h-12 sm:w-16 sm:h-16 rounded-full bg-white/5 backdrop-blur flex items-center justify-center border border-white/10 relative transition-all group-hover:border-teal-400/70 group-hover:shadow-lg group-hover:shadow-teal-500/10">
                        <i class="fas fa-plus text-teal-300 text-xl sm:text-2xl"></i>
                        <div class="absolute -bottom-0.5 -right-0.5 bg-teal-600 text-white rounded-full w-5 h-5 sm:w-6 sm:h-6 flex items-center justify-center border-2 border-[#0F1F28] shadow-md">
                            <i class="fas fa-pray text-[10px] sm:text-[12px]"></i>
                        </div>
                    </div>
                    <span class="text-[9px] sm:text-[11px] mt-1 sm:mt-2 font-medium text-white/50 group-hover:text-white/80 whitespace-nowrap">add status</span>
                </div>
                
                <div id="status-list" class="flex gap-2 sm:gap-5"></div>
                <div class="border-l mx-0.5 sm:mx-1 h-8 sm:h-12 border-white/10 flex-shrink-0"></div>
            </div>

            <!-- USER LIST -->
            <div id="user-list" class="flex-1 overflow-y-auto px-2 py-2" style="display: block;"></div>

            <!-- CHAT WINDOW - Shown/hidden -->
            <div id="chat-area" class="flex-1 flex flex-col overflow-hidden bg-soft-radial relative hidden">
                <!-- Back button -->
                <div class="flex items-center gap-3 p-3 bg-[#0C1C24]/50 backdrop-blur-sm border-b border-white/5">
                    <button id="back-to-list" onclick="showUserList()" class="w-8 h-8 rounded-full bg-white/5 flex items-center justify-center text-white/70 hover:text-white hover:bg-white/10 transition">
                        <i class="fas fa-arrow-left text-sm"></i>
                    </button>
                    <div>
                        <h3 id="chat-contact-name" class="text-white/90 font-medium text-sm">Loading...</h3>
                        <p id="chat-contact-status" class="text-[10px] text-white/40">...</p>
                    </div>
                </div>
                
                <!-- Chat window -->
                <div id="chat-window" class="flex-1 p-5 flex flex-col space-y-4 overflow-y-auto bg-[url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI4MCIgaGVpZ2h0PSI4MCIgdmlld0JveD0iMCAwIDQwIDQwIj48cGF0aCBkPSJNMjAgMjBhMTAgMTAgMCAwIDEgMjAgMCAxMCAxMCAwIDAgMS0yMCAweiIgZmlsbD0icmdiYSgyNTUsMjU1LDI1NSwwLjAyKSIvPjwvc3ZnPg==')]">
                    <div class="flex-1 flex flex-col justify-center items-center text-white/20">
                        <i class="fas fa-dove text-6xl mb-4 opacity-30"></i>
                        <p class="text-sm font-light text-white/40">encrypted Â· sacred communion</p>
                        <p class="text-xs text-white/20 mt-1">select a soul to message</p>
                    </div>
                </div>

                <!-- Reply preview bar -->
<div id="reply-preview" class="hidden mx-5 mb-2 p-3 bg-[#1A2F38] rounded-xl border-l-4 border-teal-400 flex items-center justify-between">
    <div class="flex items-center gap-3 flex-1 min-w-0">
        <i class="fas fa-reply text-teal-400 text-sm"></i>
        <div class="flex-1 min-w-0">
            <p id="reply-sender" class="text-teal-400 text-xs font-bold uppercase tracking-wider">Replying to</p>
            <p id="reply-message" class="text-white/80 text-sm truncate"></p>
        </div>
    </div>
    <button onclick="cancelReply()" class="text-white/40 hover:text-white text-xl ml-2">
        <i class="fas fa-times-circle"></i>
    </button>
</div>

<!-- Context menu for messages -->
<div id="message-context-menu" class="hidden fixed z-50 bg-[#1E2F38] rounded-xl shadow-2xl border border-white/10 py-2 min-w-[150px]">
    <button onclick="replyToMessage()" class="w-full px-4 py-3 text-left text-white/90 hover:bg-teal-500/20 flex items-center gap-3">
        <i class="fas fa-reply text-teal-400"></i>
        <span>Reply</span>
    </button>
</div>

                <div id="typing-notif" class="px-5 text-[11px] text-teal-300 font-medium h-5 bg-transparent"></div>
                
                <!-- MEDIA PREVIEW -->
                <div id="media-preview" class="hidden mx-5 mb-3 p-4 bg-[#0E262E]/80 backdrop-blur-xl rounded-2xl border border-white/10 flex items-center justify-between shadow-2xl">
                    <div class="flex items-center gap-4">
                        <div id="preview-icon" class="text-teal-400 text-2xl"></div>
                        <div>
                            <p id="preview-name" class="text-sm font-medium truncate w-48 text-white/90"></p>
                            <p id="preview-size" class="text-[10px] text-white/40 uppercase font-bold"></p>
                        </div>
                    </div>
                    <button onclick="clearPreview()" class="text-white/40 hover:text-teal-300 transition text-2xl">
                        <i class="fas fa-times-circle"></i>
                    </button>
                </div>

                <!-- FOOTER -->
                <footer class="p-2 sm:p-4 bg-[#0C1C24]/70 backdrop-blur-2xl border-t border-white/5 flex items-center gap-1 sm:gap-3 shrink-0 mb-3">
                    <label class="p-2 sm:p-3 cursor-pointer text-white/50 hover:text-teal-300 transition bg-white/5 rounded-full backdrop-blur-sm hover:bg-teal-500/10 flex-shrink-0">
                        <i class="fas fa-paperclip text-lg sm:text-xl"></i>
                        <input type="file" id="file-input" class="hidden" onchange="handleFileSelection(this)">
                    </label>
                    <input type="text" id="msg-input" oninput="sendTypingStatus()" placeholder="write a message..." class="flex-1 min-w-0 p-2 sm:p-4 glass-input rounded-full outline-none text-xs sm:text-sm placeholder:text-white/30 shadow-inner">
                    <button id="mic-btn" onclick="toggleVoiceRecording()" class="p-2 sm:p-3 text-white/50 hover:text-teal-300 transition bg-white/5 rounded-full backdrop-blur-sm hover:bg-teal-500/10 flex-shrink-0">
                        <i class="fas fa-microphone text-lg sm:text-xl"></i>
                    </button>
                    <button id="send-btn" onclick="processMessageSend()" class="w-8 h-8 sm:w-10 sm:h-10 bg-gradient-to-br from-teal-500 to-emerald-500 text-white rounded-full flex items-center justify-center shadow-xl shadow-teal-500/30 active:scale-90 hover:scale-105 transition-all duration-200 flex-shrink-0">
                        <i class="fas fa-paper-plane text-sm sm:text-base"></i>
                    </button>
                </footer>
                <div id="recording-timer" class="text-center text-teal-300 text-[10px] sm:text-[11px] font-bold py-1 sm:py-1.5 bg-[#0C1C24]/90 backdrop-blur-sm hidden">RECORDING: 0s</div>
            </div>
        </div>       
    </main>
</div>

<!-- CALL MODAL -->
<div id="call-modal" class="modal-overlay fixed inset-0 bg-black/95 z-[3000] hidden flex-col items-center justify-center text-white">
    <div class="flex flex-col items-center gap-6 w-full max-w-4xl relative">
        <!-- Timer will be inserted here dynamically -->
        
        <!-- Video containers -->
        <div class="relative w-full h-[70vh] bg-gray-900 rounded-3xl overflow-hidden shadow-2xl border border-white/10">
            <!-- Remote video (full size) -->
            <video id="remote-video" autoplay class="w-full h-full object-cover"></video>
            
            <!-- Local video (picture-in-picture) - Mobile Optimized -->
        <video id="local-video" autoplay muted class="absolute bottom-4 right-4 w-24 h-40 sm:w-28 sm:h-48 md:w-32 md:h-56 lg:w-36 lg:h-64 bg-black rounded-xl border-2 border-white/20 object-cover shadow-lg cursor-pointer hover:border-teal-400 transition-all duration-300 z-30" style="max-width: 140px; max-height: 210px; touch-action: none;" onclick="toggleLocalVideoSize()" ontouchstart="handleVideoTouchStart(event)" ontouchmove="handleVideoTouchMove(event)" ontouchend="handleVideoTouchEnd(event)">
        </video>

            <!-- Call info overlay -->
            <div class="absolute top-4 left-4 bg-black/50 backdrop-blur-md px-4 py-2 rounded-full">
                <h3 id="call-user-name" class="text-lg font-semibold">Connecting...</h3>
                <p id="call-status" class="text-xs text-teal-400 animate-pulse">Ringing</p>
            </div>
        </div>

        <!-- Call controls -->
        <div class="flex gap-4 mt-4 p-4 bg-black/30 backdrop-blur-xl rounded-2xl border border-white/10">
            <!-- Mute button -->
            <button id="mute-btn" onclick="toggleMute()" class="w-8 h-8 bg-white/10 rounded-full flex items-center justify-center text-2xl text-white/80 hover:bg-white/20 hover:text-white hover:scale-110 transition-all">
                <i class="fas fa-microphone"></i>
            </button>
            
            <!-- Video toggle button -->
            <button id="video-btn" onclick="toggleVideo()" class="w-8 h-8 bg-white/10 rounded-full flex items-center justify-center text-2xl text-white/80 hover:bg-white/20 hover:text-white hover:scale-110 transition-all">
                <i class="fas fa-video"></i>
            </button>
            
            <!-- Answer button (only shows for incoming calls) -->
            <button id="answer-btn" onclick="answerCall()" class="hidden w-10 h-10 bg-gradient-to-r from-teal-500 to-emerald-500 rounded-full flex items-center justify-center text-2xl text-white shadow-xl hover:scale-110 transition-all">
                <i class="fas fa-phone"></i>
            </button>
            
            <!-- Hangup button (always visible) -->
            <button id="hangup-btn" onclick="endCall()" class="w-10 h-10 bg-gradient-to-r from-red-600 to-rose-600 rounded-full flex items-center justify-center text-2xl text-white shadow-xl hover:scale-110 transition-all">
                <i class="fas fa-phone-slash"></i>
            </button>
            
            <!-- Speaker button -->
            <button id="speaker-btn" onclick="toggleSpeaker()" class="w-8 h-8 bg-white/10 rounded-full flex items-center justify-center text-2xl text-white/80 hover:bg-white/20 hover:text-white hover:scale-110 transition-all">
                <i class="fas fa-volume-up"></i>
            </button>
            
            <!-- Fullscreen button -->
            <button id="fullscreen-btn" onclick="toggleFullscreen()" class="w-8 h-8 bg-white/10 rounded-full flex items-center justify-center text-2xl text-white/80 hover:bg-white/20 hover:text-white hover:scale-110 transition-all">
                <i class="fas fa-expand"></i>
            </button>
        </div>
        
        <!-- End call reason message -->
        <div id="call-end-message" class="hidden text-sm text-red-400 mt-2 animate-pulse"></div>
    </div>
</div>

<script>
    // ===== CORE CONFIGURATION =====
    const API_URL = "https://script.google.com/macros/s/AKfycbyApGDpe3VVqOD-AKwqrrTFXcpQxhj_6bWfI1-KkV55wHc2g1epVgNpsGInuXuRnOt1/exec"; 
    const CLOUD_NAME = "dprnytwp9";
    const UPLOAD_PRESET = "AppPortal-Chat";

    // ===== MESSAGING VARIABLES =====
    let isRefreshingChat = false; // Add this
    let sessionToken = localStorage.getItem('chat_token');
    let currentUserEmail = null, activeContact = null, selectedFile = null;
    let lastMsgCount = 0, userStatuses = {}, typingTimer;
    let mediaRecorder, audioChunks = [], isRecording = false, recordStartTime, timerInterval;
    let allUsersGlobal = [];
    let messageStatuses = {};
    let replyingTo = null; // Store message being replied to
    let contextMenuMessage = null; // For long-press menu
    let contextMenuTimer = null;

    // ===== CALL SYSTEM VARIABLES =====
    const ringtone = new Audio('https://assets.mixkit.co/active_storage/sfx/1359/1359-preview.mp3');
    ringtone.loop = true; // Make it loop until answered or rejected

    let peer = null;
    let myPeerId = null;
    let callRejected = false;
    let callState = {
        currentCall: null,
        incomingCall: null,
        isInCall: false,
        callPeerId: null,
        callStartTime: null,
        callTimerInterval: null,
        isOutgoing: false,  
        isIncoming: false,
        callAnswered: false,
        noAnswer: false,
        callEnded: false,
        callTimeout: null 
    };

    let callTimeout = null;
    const CALL_TIMEOUT_DURATION = 15000; // 15 seconds timeout
    let localStream = null;

    // Call control states
    let isMuted = false;
    let isVideoOff = false;
    let isSpeakerOn = true;

    let drafts = {}; // Store message drafts per contact
    let fileDrafts = {}; // Store file drafts per contact

    // ===== API HELPER =====
    async function apiRequest(f, d) {
        try {
            const p = new URLSearchParams();
            p.append('function', f);
            p.append('data', JSON.stringify({ ...d, token: sessionToken }));
            const r = await fetch(API_URL, { method: 'POST', body: p });
            return await r.json();
        } catch (e) { return { success: false, error: e.toString() }; }
    }

    // ===== MODAL HELPERS =====
    function showAlert(title, text, iconClass = "fa-check-circle") {
        document.getElementById('modal-title').innerText = title;
        document.getElementById('modal-text').innerText = text;
        document.getElementById('modal-icon').innerHTML = `<i class="fas ${iconClass}"></i>`;
        document.getElementById('custom-modal').style.display = 'flex';
    }
    function closeModal() { document.getElementById('custom-modal').style.display = 'none'; }
    
    function openStatusModal() { document.getElementById('status-modal').style.display = 'flex'; }
    function closeStatusModal() { 
        document.getElementById('status-modal').style.display = 'none'; 
        document.getElementById('status-input-text').value = '';
    }

    // ===== AUTH =====
    let currentUser = { email: "", name: "", profilePic: "" };

    window.onload = validate;

    async function handleLogin() {
        const e = document.getElementById('login-email').value, 
              p = document.getElementById('login-pass').value;
        if(!e || !p) return showAlert("Login Failed", "Please enter both email and password", "fa-exclamation-triangle text-red-500");

        const res = await apiRequest('login', { email: e, password: p });
        if (res.success) { 
            localStorage.setItem('chat_token', res.token); 
            location.reload(); 
        }
        else showAlert("Login Failed", res.error, "fa-exclamation-triangle text-red-500");
    }

    async function validate() {
        if (!sessionToken) return;
        
        const res = await apiRequest('validateSession', {});
        
        if (res.success) {
            currentUser = {
                email: res.email,
                name: res.name,
                profilePic: res.profilePic
            };
            currentUserEmail = res.email;
            
            const myAvatar = document.getElementById('my-avatar');
            if (myAvatar) {
                myAvatar.innerHTML = getAvatarHTML(currentUser.name, currentUser.profilePic, "w-10 h-10");
            }

            document.getElementById('contact-avatar-container').style.display = 'none';
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('main-chat').style.display = 'flex';
            
            initCallSystem();
            startLoops();
        } else {
            localStorage.removeItem('chat_token');
        }
    }

   // ===== CONTACTS & NOTIFICATIONS =====
async function refreshUserList() {
    const usersRes = await apiRequest('getAllUsers', {});
    const unreadRes = await apiRequest('getNotifications', {});
    const lastMessagesRes = await apiRequest('getLastMessages', {});
    console.log('Raw lastMessages response:', JSON.stringify(lastMessagesRes));

    // Create a map of last messages
    const lastMessagesMap = {};
if (lastMessagesRes.success) {
    lastMessagesRes.messages.forEach(msg => {
        // Check if it's media (has mimetype and URL)
        if (msg.mimeType && msg.message && typeof msg.message === 'string' && msg.message.startsWith('http')) {
            if (msg.mimeType.includes('image')) {
                lastMessagesMap[msg.sender] = 'ðŸ“· Photo';
            } else if (msg.mimeType.includes('video')) {
                lastMessagesMap[msg.sender] = 'ðŸŽ¥ Video';
            } else if (msg.mimeType.includes('audio')) {
                lastMessagesMap[msg.sender] = 'ðŸŽ¤ Voice message';
            } else {
                lastMessagesMap[msg.sender] = 'ðŸ“Ž Attachment';
            }
        } else {
            // Regular text message
            lastMessagesMap[msg.sender] = msg.message;
        }
    });
}
    
    if (!usersRes.success) return;

    const myEmail = currentUser.email;

    const counts = {};
    if (unreadRes.messages) {
        unreadRes.messages.forEach(m => { counts[m[1]] = (counts[m[1]] || 0) + 1; });
    }

    document.getElementById('user-list').innerHTML = usersRes.users
        .filter(u => u.email !== myEmail)
        .map(u => {
            const escapedName = (u.name || '').replace(/'/g, "\\'");
            const escapedPic = (u.profilePic || '').replace(/'/g, "\\'");
            const unreadCount = counts[u.email] || 0;
            const isActive = activeContact === u.email;
            
            let lastActiveTime = '';
            if (u.lastActive) {
                const date = parseLastActive(u.lastActive);
                const now = new Date();
                const diffMins = Math.floor((now - date) / 60000);
                const diffHours = Math.floor((now - date) / 3600000);
                const diffDays = Math.floor((now - date) / 86400000);
                
                if (diffMins < 1) lastActiveTime = 'now';
                else if (diffMins < 60) lastActiveTime = `${diffMins}m ago`;
                else if (diffHours < 24) lastActiveTime = `${diffHours}h ago`;
                else if (diffDays < 7) lastActiveTime = `${diffDays}d ago`;
                else lastActiveTime = date.toLocaleDateString([], { month: 'short', day: 'numeric' });
            }

            const isOnline = u.lastActive && (new Date() - parseLastActive(u.lastActive)) < 120000;
            const onlineDotColor = isOnline ? 'bg-emerald-500' : 'bg-gray-400';
            
            // Get last message for this user
            const lastMessage = lastMessagesMap[u.email];
            const displayMessage = lastMessage ? 
                (lastMessage.length > 30 ? lastMessage.substring(0, 30) + '...' : lastMessage) : 
                'Tap to message';

            return `
                <div onclick="selectContact('${u.email}', '${escapedName}', '${escapedPic}')" 
                     class="chat-card flex items-center justify-between px-4 py-3 cursor-pointer transition-all w-full ${isActive ? 'active' : 'hover:bg-white/5'}">
                    
                    <div class="flex items-center gap-3 flex-1 min-w-0">
                        <div class="relative flex-shrink-0">
                            ${getAvatarHTML(u.name, u.profilePic, "w-12 h-12 text-lg")}
                            <span class="absolute bottom-0 right-0 w-3.5 h-3.5 ${onlineDotColor} border-2 border-[#0F1F28] rounded-full shadow-md"></span>
                        </div>
                        
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center justify-between">
                                <h3 class="contact-name text-sm">${u.name.split(' ')[0]}</h3>
                                <span class="timestamp text-[0.65rem] font-light">${lastActiveTime}</span>
                            </div>
                            <div class="flex items-center justify-between mt-0.5">
                                <p class="last-message truncate pr-2">
                                    <span class="text-teal-300/70 mr-1"><i class="fas fa-check-double text-[10px]"></i></span>
                                    ${u.isTyping ? 
                                    '<span class="text-teal-400 font-medium flex items-center gap-1"><i class="fas fa-pencil-alt text-[8px] animate-pulse"></i> typing...</span>' : 
                                    displayMessage}
                                </p>
                                ${unreadCount > 0 ? `<span class="unread-badge ml-2">${unreadCount}</span>` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
}

    function timeAgo(date) {
        if (typeof date === 'number' || !isNaN(date)) {
            date = parseLastActive(date);
        }
        const seconds = Math.floor((new Date() - new Date(date)) / 1000);
        if (seconds < 60) return "Just now";
        if (seconds < 3600) return Math.floor(seconds/60) + "m ago";
        if (seconds < 86400) return Math.floor(seconds/3600) + "h ago";
        return new Date(date).toLocaleDateString();
    }

    // ===== STATUS LOGIC =====
    async function submitStatus(withMedia) {
        const text = document.getElementById('status-input-text').value;
        if (!text && !withMedia) {
            showAlert("Error", "Please enter some text for your status.", "fa-info-circle text-blue-500");
            return;
        }

        closeStatusModal();
        
        if (withMedia) {
            const file = document.getElementById('status-file-hidden').files[0];
            if (!file) return;

            document.getElementById('status-list').innerHTML = `<div class="text-[10px] text-green-600 py-4 animate-pulse">Uploading Media...</div>`;
            
            const fd = new FormData(); fd.append('file', file); fd.append('upload_preset', UPLOAD_PRESET);
            const cloudRes = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/auto/upload`, { method:'POST', body:fd });
            const cloudData = await cloudRes.json();
            
            await apiRequest('updateStatus', { text: text || "Media Status", mediaUrl: cloudData.secure_url });
        } else {
            await apiRequest('updateStatus', { text: text, mediaUrl: "" });
        }
        
        refreshStatusUI();
    }

    async function refreshStatusUI() {
        const res = await apiRequest('getAllStatuses', {});
        const usersRes = await apiRequest('getAllUsers', {});

        if (!res.success || !usersRes.success) return;

        allUsersGlobal = usersRes.users;
        userStatuses = res.statuses;

        const userMap = {};
        allUsersGlobal.forEach(u => userMap[u.email] = u);
        const statusEmails = Object.keys(userStatuses);

        statusEmails.sort((a, b) => {
            if (a === currentUser.email) return -1;
            if (b === currentUser.email) return 1;
            return 0;
        }); 

        document.getElementById('status-list').innerHTML = Object.keys(userStatuses)
            .map(email => {
                const user = userMap[email] || { name: email, profilePic: "" };
                const statusData = userStatuses[email];
                const hasViewed = statusData.viewers && statusData.viewers.includes(currentUser.email);
                const ringColor = hasViewed ? 'border-white/20' : 'border-teal-400';
                const displayName = (email === currentUser.email) ? "My Status" : user.name.split(' ')[0];

                return `
                    <div class="flex flex-col items-center min-w-[50px] sm:min-w-[70px] cursor-pointer group" onclick="viewStatus('${email}')">
                        <div class="status-ring p-[1px] sm:p-[2px] border-2 ${ringColor} rounded-full transition-all duration-300 group-hover:border-teal-300/80">
                            ${getAvatarHTML(user.name, user.profilePic, "w-10 h-10 sm:w-14 sm:h-14")}
                        </div>
                        <span class="text-[11px] mt-1 sm:mt-1.5 ${hasViewed ? 'text-white/40' : 'text-white/80 font-medium'} max-w-[50px] sm:max-w-[70px]">${displayName}</span>
                    </div>`;
            }).join('');
    }

    function viewStatus(email) {
        const s = userStatuses[email];
        const viewer = document.getElementById('status-viewer');
        viewer.style.display = 'flex';

        const user = allUsersGlobal.find(u => u.email === email);
        const displayName = user ? user.name : email.split('@')[0];
        document.getElementById('viewer-avatar').innerHTML = getAvatarHTML(displayName, user?.profilePic || "", "w-10 h-10");
        document.getElementById('viewer-name').innerText = displayName;
        document.getElementById('viewer-time').innerText = timeAgo(s.time);
        document.getElementById('viewer-views').innerText = s.views || 0;
        
        const viewerNames = s.viewers.map(vEmail => {
            const vUser = allUsersGlobal.find(u => u.email === vEmail);
            return vUser ? vUser.name : vEmail.split('@')[0];
        });

        document.getElementById('viewed-by-names').innerText = viewerNames.length > 0 
            ? "Viewed by: " + viewerNames.join(', ') 
            : "No views yet";

        let mediaHtml = "";
        let duration = 6000;
        
        if (s.media) {
            if (s.media.toLowerCase().match(/\.(mp4|webm|ogg|mov)$/) || s.media.includes("video/upload")) {
                mediaHtml = `<video id="status-video" src="${s.media}" autoplay class="max-h-[75vh] rounded-2xl shadow-2xl mx-auto border border-white/10"></video>`;
            } 
            else if (s.media.toLowerCase().match(/\.(mp3|wav|ogg|m4a)$/) || s.media.includes("audio/upload")) {
                mediaHtml = `<audio id="status-audio" src="${s.media}" autoplay class="w-full max-w-md mt-4" controls></audio>`;
            }
            else {
                mediaHtml = `<img src="${s.media}" class="max-h-[75vh] rounded-2xl shadow-2xl mx-auto border border-white/10">`;
                duration = 10000;
            }
        } else {
            mediaHtml = `<div class="h-30 flex items-center justify-center"><i class="fas fa-quote-left text-5xl text-white/40"></i></div>`;
            duration = 7000;
        }
        
        document.getElementById('status-content').innerHTML = `
            ${mediaHtml}
            <div class="mt-8">
                <h2 class="text-white text-3xl font-light italic leading-relaxed">"${s.text || ''}"</h2>
                <p class="text-teal-400 text-sm mt-4 font-medium uppercase tracking-[0.2em]">${displayName}</p>
            </div>
        `;

        const fill = document.getElementById('status-fill');
        fill.style.transition = 'none';
        fill.style.width = '0%';
        
        if (s.media) {
            if (s.media.match(/\.(mp4|webm|ogg|mov|mp3|wav|m4a)$/i) || s.media.includes('video/') || s.media.includes('audio/')) {
                const mediaElement = document.querySelector('#status-video, #status-audio');
                if (mediaElement) {
                    mediaElement.onloadedmetadata = function() {
                        duration = this.duration * 1000;
                        startProgress(duration);
                    };
                    mediaElement.onerror = function() {
                        startProgress(10000);
                    };
                } else {
                    startProgress(duration);
                }
            } else {
                startProgress(duration);
            }
        } else {
            startProgress(duration);
        }
        
        function startProgress(durationMs) {
            setTimeout(() => { 
                fill.style.transition = `width ${durationMs}ms linear`; 
                fill.style.width = '100%'; 
            }, 50);
            
            setTimeout(closeStatus, durationMs);
        }
        
        apiRequest('incrementStatusView', { statusOwner: email })
            .then(res => { if (!res.success) console.warn("View record failed:", res.error); })
            .catch(err => console.error("Network error recording view:", err));
    }

    function closeStatus() { document.getElementById('status-viewer').style.display = 'none'; refreshStatusUI(); }

    // ===== AVATAR HELPER =====
    function getAvatarHTML(name, url, sizeClass = "w-10 h-10") {
        if (url && url.trim() !== "") {
            return `<img src="${url}" class="${sizeClass} rounded-full object-cover border border-white/20 shadow-lg">`;
        }
        const initial = name ? name[0].toUpperCase() : "?";
        const avatarColors = ['bg-teal-600', 'bg-emerald-600', 'bg-blue-600/80', 'bg-amber-600/80', 'bg-purple-600/80'];
        const charCode = initial.charCodeAt(0) || 0;
        const color = avatarColors[charCode % avatarColors.length];
        
        return `<div class="${sizeClass} rounded-full ${color} flex items-center justify-center text-white font-bold border border-white/20 shadow-lg text-sm">
                    ${initial}
                </div>`;
    }

    // ===== SETTINGS =====
    async function openSettings() {
        if (activeContact) return;
        
        document.getElementById('settings-avatar-preview').innerHTML = getAvatarHTML(currentUser.name, currentUser.profilePic, "w-24 h-24 text-2xl");
        document.getElementById('settings-name-input').value = currentUser.name;
        document.getElementById('settings-modal').classList.remove('hidden');
        document.getElementById('settings-modal').style.display = 'flex';
    }

    async function uploadPhoto() {
        const file = document.getElementById('pic-input').files[0];
        if (!file) return;

        document.getElementById('settings-avatar-preview').innerHTML = `<div class="w-24 h-24 rounded-full border-4 border-white/20 border-t-teal-400 animate-spin"></div>`;

        const fd = new FormData();
        fd.append('file', file);
        fd.append('upload_preset', UPLOAD_PRESET);

        try {
            const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, { method: 'POST', body: fd });
            const data = await res.json();
            
            currentUser.profilePic = data.secure_url;
            document.getElementById('settings-avatar-preview').innerHTML = getAvatarHTML(currentUser.name, currentUser.profilePic, "w-24 h-24 text-2xl");
        } catch (e) {
            alert("Upload failed");
        }
    }

    async function saveProfile() {
        const newName = document.getElementById('settings-name-input').value;
        const res = await apiRequest('updateProfile', { 
            newName: newName, 
            profilePicUrl: currentUser.profilePic 
        });
        
        if (res.success) {
            currentUser.name = newName;
            document.getElementById('my-avatar').innerHTML = getAvatarHTML(currentUser.name, currentUser.profilePic, "w-10 h-10");
            showAlert("Success", "Profile Updated!", "fa-check-circle");
            closeSettings();
        }
    }

    // ===== CHAT HISTORY & MESSAGING =====
    function selectContact(e, n, pic) {
        // Save current contact's draft before switching
    if (activeContact) {
        drafts[activeContact] = document.getElementById('msg-input').value;
        if (selectedFile) {
            fileDrafts[activeContact] = {
                file: selectedFile,
                name: selectedFile.name,
                size: selectedFile.size,
                type: selectedFile.type
            };
        }
    }
    
    // Switch to new contact
    activeContact = e;
    
    // Restore new contact's draft
    document.getElementById('msg-input').value = drafts[e] || '';
    
    if (fileDrafts[e]) {
        selectedFile = fileDrafts[e].file;
        document.getElementById('media-preview').classList.remove('hidden');
        document.getElementById('preview-name').innerText = fileDrafts[e].name;
        document.getElementById('preview-size').innerText = (fileDrafts[e].size/1024).toFixed(1) + " KB";
        document.getElementById('preview-icon').innerHTML = '<i class="fas fa-file-arrow-up"></i>';
    } else {
        clearPreview();
    }

     apiRequest('markMessagesAsDelivered', {});

        showChatArea();

        activeContact = e; 
        lastMsgCount = 0;
        document.getElementById('chat-header-name').innerHTML = `<span class="bg-gradient-to-r from-teal-300 to-emerald-200 bg-clip-text text-transparent">${n}</span> <span class="text-[10px] font-light px-2 py-0.5 bg-white/10 rounded-full text-teal-100/80">connected</span>`;

        document.getElementById('chat-contact-name').innerText = n;
        document.getElementById('chat-window').innerHTML = `
            <div class="flex-1 flex items-center justify-center text-white/40">
                <i class="fas fa-spinner fa-spin mr-2"></i> Loading messages...
            </div>`;
        
        const myAvatar = document.getElementById('my-avatar');
        const contactAvatarContainer = document.getElementById('contact-avatar-container');
        const contactAvatar = document.getElementById('contact-avatar');
        
        myAvatar.style.display = 'none';
        contactAvatarContainer.style.display = 'flex';
        contactAvatarContainer.classList.add('active');
        contactAvatar.innerHTML = getAvatarHTML(n, pic, "w-10 h-10");
        
        const user = allUsersGlobal.find(u => u.email === e);
        let lastActiveDate = parseLastActive(user?.lastActive);
        
        const isOnline = lastActiveDate && (new Date() - lastActiveDate) < 120000;
        document.getElementById('chat-header-status').innerText = isOnline ? "Online" : "Last seen " + timeAgo(lastActiveDate);
        
        apiRequest('markAsRead', { contactEmail: e });
        setTimeout(() => {
    refreshChatHistory();
        }, 100); // 100ms delay
        refreshUserList();
    }

    function resetToMyProfile() {
        activeContact = null;
        document.getElementById('chat-header-name').innerHTML = `<span class="bg-gradient-to-r from-teal-300 to-emerald-200 bg-clip-text text-transparent">Ekklo</span> <span class="text-[10px] font-light px-2 py-0.5 bg-white/10 rounded-full text-teal-100/80">connected in spirit</span>`;
        document.getElementById('chat-header-status').innerText = "Select a contact";
        
        const myAvatar = document.getElementById('my-avatar');
        const contactAvatarContainer = document.getElementById('contact-avatar-container');
        
        myAvatar.style.display = 'flex';
        myAvatar.innerHTML = getAvatarHTML(currentUser.name, currentUser.profilePic, "w-10 h-10");
        contactAvatarContainer.style.display = 'none';
        contactAvatarContainer.classList.remove('active');
        
        document.getElementById('chat-window').innerHTML = `
            <div class="flex-1 flex flex-col justify-center items-center text-white/20">
                <i class="fas fa-dove text-6xl mb-4 opacity-30"></i>
                <p class="text-sm font-light text-white/40">encrypted Â· sacred communion</p>
                <p class="text-xs text-white/20 mt-1">select a soul to message</p>
            </div>
        `;
        showUserList();
    }

   async function refreshChatHistory() {
    if (!activeContact) return;

    const statusCheck = await apiRequest('getMessageStatus', { contactEmail: activeContact });
    if (statusCheck.changed) {
        updateMessageStatusIcons(statusCheck.statuses);
        return;
    }

    const res = await apiRequest('getChatHistory', { contactEmail: activeContact });
    if (!res.success || res.messages.length === lastMsgCount) return;

    if (activeContact && res.messages.length > 0) {
        const chatArea = document.getElementById('chat-area');
        const isChatVisible = chatArea.classList.contains('active');
        if (isChatVisible) {
        apiRequest('markAsRead', { contactEmail: activeContact });
        }
        apiRequest('markMessagesAsDelivered', {});
    }
    
    lastMsgCount = res.messages.length;
    const win = document.getElementById('chat-window');
    
    // Get user names map for replies
    const userMap = {};
    allUsersGlobal.forEach(u => userMap[u.email] = u.name);
    
    // Group messages by date
    let lastDate = '';
    let html = '';
    
    res.messages.forEach(m => {
        const messageDate = new Date(m[3]).toDateString();
        const today = new Date().toDateString();
        const yesterday = new Date(Date.now() - 86400000).toDateString();
        
        // Add date header if date changes
        if (messageDate !== lastDate) {
            let dateDisplay = '';
            if (messageDate === today) {
                dateDisplay = 'Today';
            } else if (messageDate === yesterday) {
                dateDisplay = 'Yesterday';
            } else {
                dateDisplay = new Date(m[3]).toLocaleDateString([], { month: 'short', day: 'numeric', year: 'numeric' });
            }
            
            html += `<div class="text-center my-4">
                <span class="text-xs bg-white/10 px-3 py-1 rounded-full text-white/60">${dateDisplay}</span>
            </div>`;
            lastDate = messageDate;
        }
        
        const isMe = m[1] === currentUserEmail;
        const body = m[2], mime = m[5] || 'text/plain', time = new Date(m[3]).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
        const messageId = m[7]; // Column H: Message ID
        const replyToId = m[8]; // Column I: Reply to ID
        const replyContext = m[9]; // Reply context data

        const readStatus = m[4] || 'unread';
        const deliveryStatus = m[6] || 'sent';

        // Ensure body is a string
        const safeBody = body ? String(body) : '';
       
        // Add reply HTML if this message is a reply
        let replyHtml = '';
        if (replyContext) {
            const replySender = replyContext.sender === currentUserEmail ? 'You' : (userMap[replyContext.sender] || replyContext.sender.split('@')[0]);
            let replyText = replyContext.message;
            
            if (replyContext.mimeType && replyContext.mimeType !== 'text/plain') {
                if (replyContext.mimeType.includes('image')) replyText = 'ðŸ“· Photo';
                else if (replyContext.mimeType.includes('video')) replyText = 'ðŸŽ¥ Video';
                else if (replyContext.mimeType.includes('audio')) replyText = 'ðŸŽ¤ Voice';
                else replyText = 'ðŸ“Ž File';
            }
            
            replyHtml = `
                <div class="text-xs opacity-70 mb-1 pb-1 border-l-2 border-teal-400 pl-2 truncate cursor-pointer hover:bg-teal-500/10 transition rounded"
         onclick="jumpToMessage('${replyToId}')">
                    <span class="font-bold text-teal-300">â†ª ${replySender}</span>: ${replyText}
                </div>
            `;
        }
        
        let statusIcon = '';
        if (isMe) {
            if (readStatus === 'read') {
                statusIcon = '<i class="fas fa-check-double text-blue-400 ml-1 text-xs"></i>';
            } else if (deliveryStatus === 'delivered') {
                statusIcon = '<i class="fas fa-check-double text-gray-400 ml-1 text-xs"></i>';
            } else {
                statusIcon = '<i class="fas fa-check text-gray-400 ml-1 text-xs"></i>';
            }
        }
        
        // Create message content - USE messageContent consistently
        let messageContent = safeBody;
        if (mime.includes('image')) messageContent = `<img src="${body}" class="media-content rounded-xl cursor-pointer shadow-lg" onclick="window.open('${body}')">`;
        else if (mime.includes('video')) messageContent = `<video controls class="media-content rounded-xl shadow-lg"><source src="${body}"></video>`;
        else if (mime.includes('audio')) messageContent = `<audio controls class="w-48 h-8 mt-1"><source src="${body}"></audio>`;
        else if (body && typeof body === 'string' && body.startsWith('http')) messageContent = `<a href="${body}" target="_blank" class="bg-teal-800/40 flex items-center gap-2 text-sm underline italic text-teal-100 p-2 rounded-xl"><i class="fas fa-file-download"></i> Attachment</a>`;
        
        // Message data for context menu
        const messageData = {
            id: messageId,
            sender: m[1],
            senderName: userMap[m[1]] || m[1].split('@')[0],
            message: body,
            mimeType: mime
        };
        
        html += `<div class="flex flex-col ${isMe ? 'items-end' : 'items-start'}">
            <div class="message-bubble ${isMe ? 'sent' : 'received'}" data-message-id="${messageId}"
                 oncontextmenu="showMessageContext(event, ${JSON.stringify(messageData).replace(/"/g, '&quot;')})"
                 ontouchstart="handleTouchStart(event, ${JSON.stringify(messageData).replace(/"/g, '&quot;')})"
                 ontouchend="handleTouchEnd()">
                ${replyHtml}
                ${messageContent}  <!-- Use messageContent here, not messageHtml -->
                <div class="flex items-center justify-end gap-1 mt-1.5">
                    <span class="text-[9px] opacity-60 font-medium tracking-wider ${isMe ? 'text-teal-50' : 'text-gray-600'}">${time}</span>
                    ${statusIcon}
                </div>
            </div>
        </div>`;
    });
    
    win.innerHTML = html;
    win.scrollTop = win.scrollHeight;
}

    async function updateTypingIndicator() {
        if (!activeContact) return;
        const res = await apiRequest('getAllUsers', {});
        if (!res.success) return;

        const contact = res.users.find(u => u.email === activeContact);
        const statusElement = document.getElementById('chat-header-status');

        if (contact && contact.isTyping) {
            statusElement.innerText = "typing...";
            statusElement.classList.add('text-teal-300', 'font-bold', 'animate-pulse');
        } else {
            const lastActiveDate = parseLastActive(contact?.lastActive);
            const isOnline = lastActiveDate && (new Date() - lastActiveDate) < 120000;
            statusElement.innerText = isOnline ? "Online" : "Last seen " + timeAgo(lastActiveDate);
            statusElement.classList.remove('text-teal-300', 'font-bold', 'animate-pulse');
        }
    }

    // ===== VOICE RECORDING =====
    async function toggleVoiceRecording() {
        const micBtn = document.getElementById('mic-btn');
        const timer = document.getElementById('recording-timer');
        if (!isRecording) {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            audioChunks = []; recordStartTime = Date.now();
            mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
            mediaRecorder.onstop = async () => {
                const blob = new Blob(audioChunks, { type: 'audio/webm' });
                selectedFile = new File([blob], `voice_${Date.now()}.webm`, { type: 'audio/webm' });
                document.getElementById('media-preview').classList.remove('hidden');
                document.getElementById('preview-name').innerText = "Voice Note (Ready)";
                document.getElementById('preview-icon').innerHTML = '<i class="fas fa-microphone"></i>';
                stream.getTracks().forEach(t => t.stop());
            };
            mediaRecorder.start(); isRecording = true;
            micBtn.classList.add('recording-pulse'); timer.classList.remove('hidden');
            timerInterval = setInterval(() => { timer.innerText = `RECORDING: ${Math.floor((Date.now()-recordStartTime)/1000)}s`; }, 1000);
        } else {
            mediaRecorder.stop(); isRecording = false;
            micBtn.classList.remove('recording-pulse'); timer.classList.add('hidden');
            clearInterval(timerInterval);
        }
    }

    async function processMessageSend() {
        const input = document.getElementById('msg-input'), btn = document.getElementById('send-btn');
        let payload = input.value, mime = 'text/plain';
        if (!payload && !selectedFile) return;
        
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

        if (selectedFile) {
            const fd = new FormData(); fd.append('file', selectedFile); fd.append('upload_preset', UPLOAD_PRESET);
            const cRes = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/auto/upload`, { method:'POST', body:fd });
            const cData = await cRes.json();
            payload = cData.secure_url; mime = selectedFile.type;
        }
        
        const res = await apiRequest('uploadMedia', { recipientEmail: activeContact, message: payload, mimeType: mime, replyTo: replyingTo ? replyingTo.messageId : null });
        if (res.success) { input.value = ""; clearPreview(); cancelReply(); if (activeContact) { delete drafts[activeContact];  delete fileDrafts[activeContact]; } const fileInput = document.getElementById('file-input'); if (fileInput) fileInput.value = '';  refreshChatHistory(); }
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-paper-plane"></i>';

        // After sending message, check if receiver is online
if (res.success) {
    // Check if receiver is online
    const receiver = allUsersGlobal.find(u => u.email === activeContact);
    const isReceiverOnline = receiver?.lastActive && (new Date() - parseLastActive(receiver.lastActive)) < 120000;
    
    // Update status based on online status
    setTimeout(() => {
        refreshChatHistory(); // Refresh to show updated status
    }, 500);
}
    }

    // ===== HELPER: Parse Last Active =====
    function parseLastActive(dateValue) {
        if (!dateValue) return null;
        if (typeof dateValue === 'string' && /^\d{13}$/.test(dateValue)) {
            return new Date(parseInt(dateValue, 10));
        }
        if (typeof dateValue === 'number') {
            return new Date(dateValue);
        }
        return new Date(dateValue);
    }

    // ===== TOGGLE CHAT/USER LIST =====
    function showChatArea() {
        document.body.classList.add('chat-active');
        document.getElementById('chat-area').classList.add('active');
    }

    function showUserList() {
        document.body.classList.remove('chat-active');
        document.getElementById('chat-area').classList.remove('active');
    }

    // Show context menu on long press or right click
function showMessageContext(event, messageData) {
    event.preventDefault();
    contextMenuMessage = messageData;
    
    const menu = document.getElementById('message-context-menu');
    menu.style.left = event.pageX + 'px';
    menu.style.top = event.pageY + 'px';
    menu.classList.remove('hidden');
    
    // Hide menu on click outside
    setTimeout(() => {
        document.addEventListener('click', hideContextMenu);
    }, 100);
}

function hideContextMenu() {
    document.getElementById('message-context-menu').classList.add('hidden');
    document.removeEventListener('click', hideContextMenu);
}

// Set reply
function replyToMessage() {
    if (!contextMenuMessage || !activeContact) return;
    
    replyingTo = {
        messageId: contextMenuMessage.id,
        sender: contextMenuMessage.sender === currentUserEmail ? 'You' : contextMenuMessage.senderName,
        message: contextMenuMessage.message,
        mimeType: contextMenuMessage.mimeType
    };
    
    // Show reply preview
    const preview = document.getElementById('reply-preview');
    document.getElementById('reply-sender').innerText = `Replying to ${replyingTo.sender}`;
    
    // Show message snippet
    let messageText = replyingTo.message;
    if (replyingTo.mimeType && replyingTo.mimeType !== 'text/plain') {
    if (replyingTo.mimeType) {
        if (replyingTo.mimeType.includes('image')) messageText = 'ðŸ“· Photo';
        else if (replyingTo.mimeType.includes('video')) messageText = 'ðŸŽ¥ Video';
        else if (replyingTo.mimeType.includes('audio')) messageText = 'ðŸŽ¤ Voice message';
        else messageText = 'ðŸ“Ž Attachment';
    } }
    document.getElementById('reply-message').innerText = messageText;
    
    preview.classList.remove('hidden');
    
    // Focus input
    document.getElementById('msg-input').focus();
    hideContextMenu();
}

function cancelReply() {
    replyingTo = null;
    document.getElementById('reply-preview').classList.add('hidden');
}

 let touchTimer = null;

function handleTouchStart(event, messageData) {
    event.preventDefault();
    touchTimer = setTimeout(() => {
        showMessageContext(event, messageData);
    }, 500); // 500ms long press
}

function handleTouchEnd() {
    clearTimeout(touchTimer);
}

function jumpToMessage(messageId) {
    console.log('Attempting to jump to message:', messageId);
    
    if (!messageId) {
        console.log('No message ID provided');
        return;
    }
    
    // Try multiple selectors
    const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
    
    if (messageElement) {
        console.log('Found message element:', messageElement);
        messageElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
        messageElement.classList.add('bg-teal-500/20', 'transition-colors', 'duration-100');
        setTimeout(() => {
            messageElement.classList.remove('bg-teal-500/20');
        }, 200);
    } else {
        console.log('Message element not found with ID:', messageId);
        console.log('Available message IDs:', 
            Array.from(document.querySelectorAll('[data-message-id]')).map(el => el.dataset.messageId));
    }
}

    // ===== CALL SYSTEM =====
    function initCallSystem() {
    if (peer) return;

    myPeerId = currentUserEmail.toLowerCase().replace(/[^a-z0-9]/g, "");
    peer = new Peer(myPeerId);

    // Listen for Signal Data (Hangup/Reject)
    peer.on('connection', (conn) => {
        conn.on('data', (data) => {
            const msg = JSON.parse(data);

             if (callState.callEnded) return;

            if (msg.type === 'call-rejected') {
            console.log("Call was rejected");
            showAlert("Call Declined", "The User declined your call");
            performLocalCleanup();
        } else if (msg.type === 'no-answer') {
            console.log("Call was not answered");
            showAlert("No Answer", "The User did not answer");
            performLocalCleanup();
        } else if (msg.type === 'call-cancelled') {
            console.log("Call was cancelled");
            showAlert("Call Cancelled", "The caller hung up");
            performLocalCleanup();
        } else if (msg.type === 'call-ended') {
            console.log("Call ended by remote");
            showAlert("Call Ended", "The User ended the call");
            performLocalCleanup();
        } else if (msg.type === 'busy') {
            console.log("User is busy");
            showAlert("Busy", "The User on another call");
            performLocalCleanup();
        }

        });
    });

    // Handle Incoming Media Call
    peer.on('call', (incomingCall) => {
        if (callState.isInCall) {
            // Send busy signal via data connection then close
            const conn = peer.connect(incomingCall.peer);
            conn.on('open', () => {
                conn.send(JSON.stringify({ type: 'busy' }));
                setTimeout(() => { conn.close(); incomingCall.close(); }, 500);
                ringtone.play().catch(e => console.log("Audio play blocked"));
                showIncomingCallUI();
            });
            return;
        }
        callState.incomingCall = incomingCall;
        callState.isIncoming = true;
        showIncomingCallUI(); // Your existing UI trigger

        // Try to find the caller's name
        const caller = allUsersGlobal.find(u => 
            u.email.toLowerCase().replace(/[^a-z0-9]/g, "") === incomingCall.peer
        );

        // Open incoming call UI
        document.getElementById('call-modal').style.display = 'flex';
        document.getElementById('call-user-name').innerText = caller ? caller.name : "Incoming Call";
        document.getElementById('call-status').innerText = "Incoming call...";
        document.getElementById('answer-btn').classList.remove('hidden');
        document.getElementById('hangup-btn').classList.remove('hidden');
        
        // Set timeout for unanswered incoming call
        callTimeout = setTimeout(() => {
            if (callState.incomingCall && !callState.isInCall) {
                
                 // Send 'no-answer' signal to caller
            const signalConn = peer.connect(incomingCall.peer);
            signalConn.on('open', () => {
                signalConn.send(JSON.stringify({ 
                    type: 'no-answer',
                    from: myPeerId 
                }));
                setTimeout(() => {
                    signalConn.close();
                }, 200);
            });

                showAlert("Missed Call", "You missed a call from " + (caller ? caller.name : "unknown"));
                endCall();
            }
        }, CALL_TIMEOUT_DURATION);
    });
}

    /* --- CALLING LOGIC --- */

// 1. Initialize PeerJS when user validates session
function setupPeer() {
    if (!currentUserEmail) return;
    
    myPeerId = currentUserEmail.toLowerCase().replace(/[^a-z0-9]/g, "");
    
    // Only create peer if it doesn't exist
    if (!peer || peer.destroyed) {
        peer = new Peer(myPeerId);
    }

    peer.on('open', (id) => console.log('Call System Ready. ID:', id));

    peer.on('call', (incomingCall) => {
        currentCall = incomingCall;
        
        // Find who is calling from your global user list
        const callerEmail = incomingCall.peer; // This is the sanitized ID
        const caller = allUsersGlobal.find(u => 
            u.email.toLowerCase().replace(/[^a-z0-9]/g, "") === callerEmail
        );
        
        const callerName = caller ? caller.name : "Unknown Caller";
        
        showIncomingCallUI(callerName);
    });
}

    async function initiateCall(videoEnabled) {
    if (!peer) {
        showAlert("Error", "Call system not ready. Please wait a moment and try again.");
        return;
    }

    if (!activeContact) return showAlert("Error", "Select a contact first");
    
    if (callState.isInCall) {
        showAlert("Error", "You're already in a call. End it first.");
        return;
    }

    const targetPeerId = activeContact.toLowerCase().replace(/[^a-z0-9]/g, "");
    
    try {
        if (callTimeout) clearTimeout(callTimeout);
        
        localStream = await navigator.mediaDevices.getUserMedia({ 
            video: videoEnabled, 
            audio: true 
        });
        
        document.getElementById('local-video').srcObject = localStream;
        document.getElementById('call-modal').style.display = 'flex';
        document.getElementById('answer-btn').classList.add('hidden');
        document.getElementById('hangup-btn').classList.remove('hidden');
        
        const contactName = document.getElementById('chat-contact-name')?.innerText || document.getElementById('chat-header-name').innerText;
        document.getElementById('call-user-name').innerText = "Calling " + contactName;
        document.getElementById('call-status').innerText = "Ringing...";
        
        callState.isInCall = true;
        callState.callPeerId = targetPeerId;
        callState.isOutgoing = true;
        callState.callAnswered = false;
        callState.noAnswer = false;

        // Check if user is online first (using your existing online status)
        const user = allUsersGlobal.find(u => u.email === activeContact);
        const lastActive = user?.lastActive ? parseLastActive(user.lastActive) : null;
        const isOnline = lastActive && (new Date() - lastActive) < 120000; // 2 minutes
        
        if (!isOnline) {
            showAlert("User Offline", `${contactName} is currently offline. Please try again later.`);
            endCall();
            return;
        }
        
        const call = peer.call(targetPeerId, localStream);
        callState.currentCall = call;
        
        // Set timeout for NO ANSWER (15 seconds)
        const noAnswerTimeout = setTimeout(() => {
            if (callState.isInCall && callState.currentCall && !callState.callAnswered) {
                console.log("No answer timeout triggered");
                callState.noAnswer = true;
                callState.callEnded = true;
                showAlert("No Answer", `${contactName} did not answer`);
                endCall();
            }
        }, 15000); // 15 seconds for no answer
        
        callState.callTimeout = noAnswerTimeout;

        // ERROR HANDLER FOR FAILED CALLS (offline, etc)
        call.on('error', (err) => {
            console.error("Call failed:", err);
            clearTimeout(callState.callTimeout);
            
            if (err.type === 'peer-unavailable') {
                showAlert("User Offline", `${contactName} is currently offline`);
            } else if (err.message && err.message.includes('does not exist')) {
                showAlert("User Offline", `${contactName} is not connected to the call system`);
            } else {
                showAlert("Call Failed", "Could not connect to user. User is offline");
            }
            endCall();
        });
        
        const dataConnection = peer.connect(targetPeerId);

        dataConnection.on('error', (err) => {
            console.error("Data connection failed:", err);
        });

        dataConnection.on('open', () => {
            // Clear the no answer timeout since we have a data connection
            clearTimeout(callState.callTimeout);
            
            dataConnection.send(JSON.stringify({ 
                type: 'call-initiated',
                from: myPeerId,
                to: targetPeerId
            }));
        });
        
        handleCallEvents(call);
        ringtone.play().catch(e => console.log("Audio play blocked by browser"));
        
    } catch (err) {
        console.error(err);
        showAlert("Media Error", "Could not access camera/mic. Please check permissions.");
        callState.isInCall = false;
        performLocalCleanup();
    }
}

    async function answerCall() {
        if (!callState.incomingCall) return;
        
        try {
            ringtone.pause();
            ringtone.currentTime = 0;

            if (callTimeout) {
                clearTimeout(callTimeout);
                callTimeout = null;
            }
            
            localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            document.getElementById('local-video').srcObject = localStream;
            document.getElementById('answer-btn').classList.add('hidden');
            
            callState.currentCall = callState.incomingCall;
            callState.isInCall = true;
            callState.callPeerId = callState.incomingCall.peer;
            callState.incomingCall = null;
            
            callState.currentCall.answer(localStream);
            
            const dataConnection = peer.connect(callState.currentCall.peer);
            dataConnection.on('open', () => {
                dataConnection.send(JSON.stringify({ 
                    type: 'call-answered',
                    from: myPeerId
                }));
            });
            
            handleCallEvents(callState.currentCall);
        } catch (err) {
            showAlert("Error", "Failed to access camera/mic.");
            endCall();
        }
    }

    function handleCallEvents(call) {
    // Clear any existing timeouts
    if (callTimeout) {
        clearTimeout(callTimeout);
        callTimeout = null;
    }
    
    call.on('stream', (remoteStream) => {
        console.log("Call answered - stream received");
        
        // Mark call as answered
        callState.callAnswered = true;
        callState.noAnswer = false;
        
        // Stop ringing
        ringtone.pause();
        ringtone.currentTime = 0;

        // Display remote video
        const remoteVid = document.getElementById('remote-video');
        remoteVid.srcObject = remoteStream;
        document.getElementById('call-status').innerText = "On Call";
        document.getElementById('call-status').classList.remove('animate-pulse');
        
        // Start call timer
        startCallTimer();
    });

    call.on('close', () => {
        console.log('Call closed by remote user');
        
        // Stop ringing if it's still playing
        ringtone.pause();
        ringtone.currentTime = 0;
        
        if (callState.isInCall) {
            // Only show "Call Ended" if it was an established call
            if (callState.callAnswered) {
                showAlert("Call Ended", "The call has ended");
            }
            endCall();
        }
    });
    
    call.on('error', (err) => {
        console.error("Call error:", err);
        
        // Stop ringing
        ringtone.pause();
        ringtone.currentTime = 0;
        
        clearTimeout(callTimeout);
        
        if (callState.isInCall) {
            // Don't show error if we already handled it (like no answer)
            if (!callState.noAnswer) {
                if (err.type === 'peer-unavailable' || err.message?.includes('does not exist')) {
                    showAlert("User Offline", "User is unavailable");
                } else {
                    showAlert("Call Error", "Connection lost");
                }
            }
            endCall();
        }
    });
    
    // Monitor ICE connection state
    call.on('iceStateChanged', (state) => {
        console.log("ICE connection state:", state);
        
        if (state === 'failed' || state === 'disconnected') {
            console.log("ICE connection failed or disconnected");
            
            // Stop ringing
            ringtone.pause();
            ringtone.currentTime = 0;
            
            if (callState.isInCall && !callState.callAnswered && !callState.noAnswer) {
                // Connection failed before call was answered
                showAlert("Connection Failed", "Could not establish connection");
                endCall();
            } else if (callState.isInCall && callState.callAnswered) {
                // Connection lost during active call
                showAlert("Call Dropped", "Connection lost");
                endCall();
            }
        }
    });

    // Add handler for call connection state
    call.on('connectionStateChanged', (state) => {
        console.log("Connection state changed:", state);
        
        if (state === 'failed' || state === 'disconnected' || state === 'closed') {
            // Stop ringing
            ringtone.pause();
            ringtone.currentTime = 0;
        }
    });
}


    function showIncomingCallUI() {
    const modal = document.getElementById('call-modal');
    modal.style.display = 'flex';
    document.getElementById('answer-btn').classList.remove('hidden');
    document.getElementById('call-status').innerText = "Incoming Call...";
    document.getElementById('call-user-name').innerText = name;
}

    function endCall() {
        if (!peer) {
        console.log("Peer not initialized, performing local cleanup only");
        performLocalCleanup();
        return;
    }
    ringtone.pause();
    ringtone.currentTime = 0;

    // 1. Identify who to signal
    const targetId = callState.callPeerId || (callState.incomingCall ? callState.incomingCall.peer : null);

     if (targetId) {
        // Try to signal, but don't wait forever
        const signalConn = peer.connect(targetId);
        
        // Set a timeout for the connection attempt
        const connectionTimeout = setTimeout(() => {
            console.log("Signal connection timeout, cleaning up locally");
            performLocalCleanup();
        }, 2000);
        
        signalConn.on('open', () => {
            clearTimeout(connectionTimeout);

             // Determine signal type
            let signalType;
            if (!callState.isInCall && callState.incomingCall) {
                // This is an incoming call being rejected
                signalType = 'call-rejected';
            } else if (callState.noAnswer) {
                // This was a no-answer timeout
                signalType = 'no-answer';
            } else if (callState.isOutgoing && !callState.callAnswered) {
                // Outgoing call ended before being answered (user hung up)
                signalType = 'call-cancelled';
            } else {
                // Normal call end
                signalType = 'call-ended';
            }

            signalConn.send(JSON.stringify({ type: signalType, from: myPeerId }));
            
            setTimeout(() => {
                signalConn.close();
                performLocalCleanup();
            }, 200);
        });
        
        signalConn.on('error', () => {
            clearTimeout(connectionTimeout);
            performLocalCleanup();
        });
    } else {
        performLocalCleanup();
    }
}

// 3. Helper to reset UI and stop camera
function performLocalCleanup() {
    ringtone.pause();
    ringtone.currentTime = 0;

    if (callTimeout) clearTimeout(callTimeout);
    stopCallTimer();
    stopMedia();

    if (callState.currentCall) callState.currentCall.close();
    if (callState.incomingCall) callState.incomingCall.close();

    // Reset State
    callState.isInCall = false;
    callState.currentCall = null;
    callState.incomingCall = null;
    callState.callPeerId = null;

    // Reset UI
    document.getElementById('call-modal').style.display = 'none';
    document.getElementById('remote-video').srcObject = null;
    document.getElementById('local-video').srcObject = null;
    console.log("Local call state cleaned up.");
}

    function stopMedia() {
        if (localStream) {
            localStream.getTracks().forEach(track => {
                track.stop();
                track.enabled = false;
            });
            localStream = null;
        }
    }

    // ===== CALL CONTROL FUNCTIONS =====
    function toggleMute() {
        if (!localStream) return;
        
        isMuted = !isMuted;
        const audioTracks = localStream.getAudioTracks();
        audioTracks.forEach(track => track.enabled = !isMuted);
        
        const muteBtn = document.getElementById('mute-btn');
        muteBtn.innerHTML = isMuted ? '<i class="fas fa-microphone-slash text-red-400"></i>' : '<i class="fas fa-microphone"></i>';
        muteBtn.classList.toggle('bg-red-500/20', isMuted);
    }

    function toggleVideo() {
        if (!localStream) return;
        
        isVideoOff = !isVideoOff;
        const videoTracks = localStream.getVideoTracks();
        videoTracks.forEach(track => track.enabled = !isVideoOff);
        
        const videoBtn = document.getElementById('video-btn');
        videoBtn.innerHTML = isVideoOff ? '<i class="fas fa-video-slash text-red-400"></i>' : '<i class="fas fa-video"></i>';
        videoBtn.classList.toggle('bg-red-500/20', isVideoOff);
    }

    function toggleSpeaker() {
        isSpeakerOn = !isSpeakerOn;
        const remoteVideo = document.getElementById('remote-video');
        if (remoteVideo) {
            remoteVideo.volume = isSpeakerOn ? 1 : 0;
        }
        
        const speakerBtn = document.getElementById('speaker-btn');
        speakerBtn.innerHTML = isSpeakerOn ? '<i class="fas fa-volume-up"></i>' : '<i class="fas fa-volume-mute text-red-400"></i>';
    }

    function toggleFullscreen() {
        const container = document.querySelector('#call-modal .relative');
        if (!document.fullscreenElement) {
            container.requestFullscreen();
            document.getElementById('fullscreen-btn').innerHTML = '<i class="fas fa-compress"></i>';
        } else {
            document.exitFullscreen();
            document.getElementById('fullscreen-btn').innerHTML = '<i class="fas fa-expand"></i>';
        }
    }

    function toggleLocalVideoSize() {
        const localVideo = document.getElementById('local-video');
        localVideo.classList.toggle('w-40');
        localVideo.classList.toggle('h-56');
        localVideo.classList.toggle('w-60');
        localVideo.classList.toggle('h-80');
    }

    // ===== CALL TIMER FUNCTIONS =====
    function startCallTimer() {
        callState.callStartTime = Date.now();
        const timerElement = document.createElement('div');
        timerElement.id = 'call-timer';
        timerElement.className = 'absolute top-4 left-1/2 transform -translate-x-1/2 bg-black/50 backdrop-blur-md text-white px-4 py-2 rounded-full text-sm font-mono border border-white/10';
        document.getElementById('call-modal').querySelector('.relative').appendChild(timerElement);
        
        callState.callTimerInterval = setInterval(() => {
            const elapsed = Math.floor((Date.now() - callState.callStartTime) / 1000);
            const minutes = Math.floor(elapsed / 60).toString().padStart(2, '0');
            const seconds = (elapsed % 60).toString().padStart(2, '0');
            timerElement.textContent = `${minutes}:${seconds}`;
        }, 1000);
    }

    function stopCallTimer() {
        if (callState.callTimerInterval) {
            clearInterval(callState.callTimerInterval);
            callState.callTimerInterval = null;
        }
        const timerElement = document.getElementById('call-timer');
        if (timerElement) timerElement.remove();
    }

    // ===== HELPERS & LOOPS =====
    function handleFileSelection(i) {
        selectedFile = i.files[0];
        if(!selectedFile) return;

        if (activeContact) {
        fileDrafts[activeContact] = {
            file: selectedFile,
            name: selectedFile.name,
            size: selectedFile.size,
            type: selectedFile.type
        };
    }
        document.getElementById('media-preview').classList.remove('hidden');
        document.getElementById('preview-name').innerText = selectedFile.name;
        document.getElementById('preview-size').innerText = (selectedFile.size/1024).toFixed(1) + " KB";
        document.getElementById('preview-icon').innerHTML = '<i class="fas fa-file-arrow-up"></i>';
    }
    
    function clearPreview() { 
        selectedFile = null; 
        document.getElementById('media-preview').classList.add('hidden'); 
    }
    
    function handleLogout() { 
        localStorage.removeItem('chat_token');  
        resetToMyProfile(); 
        location.reload(); 
    }

    function sendTypingStatus() {
        if (!activeContact) return;
        apiRequest('setTyping', { isTyping: true, typingTo: activeContact });
        clearTimeout(typingTimer);
        typingTimer = setTimeout(() => apiRequest('setTyping', { isTyping: false, typingTo: activeContact }), 2000);
    }
    
    function closeSettings() { 
        document.getElementById('settings-modal').style.display = 'none'; 
    }
    
    function startLoops() {
        apiRequest('heartbeat', {}); 
        refreshUserList(); 
        refreshStatusUI();
        
        setInterval(() => apiRequest('heartbeat', {}), 60000);
        setInterval(refreshUserList, 5000);
        setInterval(() => { if (activeContact) {refreshChatHistory(); if (document.getElementById('chat-area').classList.contains('active')) { apiRequest('markAsRead', { contactEmail: activeContact }); } } updateTypingIndicator(); }, 3000);
        setInterval(refreshStatusUI, 5000);
        setInterval(() => { if (currentUserEmail) { apiRequest('markMessagesAsDelivered', {}); } }, 3000);
    }

    function saveDraft() {
    if (!activeContact) return;
    const msgInput = document.getElementById('msg-input');
    drafts[activeContact] = msgInput.value;
}

// Add this to your input event listener
document.getElementById('msg-input').addEventListener('input', saveDraft);


// Camera switching variables
let currentCamera = 'user'; // 'user' for front, 'environment' for back
let videoTracks = null;

// Touch drag functionality with boundary limits
let touchStartX = 0;
let touchStartY = 0;
let videoElement = null;
let isDragging = false;

function handleVideoTouchStart(event) {
    event.preventDefault();
    event.stopPropagation();
    
    videoElement = document.getElementById('local-video');
    const touch = event.touches[0];
    touchStartX = touch.clientX;
    touchStartY = touch.clientY;
    
    // Get current position (default to top-right if not set)
    const rect = videoElement.getBoundingClientRect();
    videoElement.dataset.startLeft = rect.left || (window.innerWidth - videoElement.offsetWidth - 20);
    videoElement.dataset.startTop = rect.top || 20;
    
    // Store original dimensions for boundary calculations
    videoElement.dataset.width = videoElement.offsetWidth;
    videoElement.dataset.height = videoElement.offsetHeight;
    
    isDragging = true;
}

function handleVideoTouchMove(event) {
    event.preventDefault();
    event.stopPropagation();
    
    if (!isDragging || !videoElement) return;
    
    const touch = event.touches[0];
    const deltaX = touch.clientX - touchStartX;
    const deltaY = touch.clientY - touchStartY;
    
    // Calculate new position
    let newLeft = parseFloat(videoElement.dataset.startLeft) + deltaX;
    let newTop = parseFloat(videoElement.dataset.startTop) + deltaY;
    
    // Get video dimensions
    const videoWidth = videoElement.offsetWidth;
    const videoHeight = videoElement.offsetHeight;
    
    // STRICT BOUNDARY CONSTRAINTS - Keep within screen edges
    const minLeft = 10; // Minimum left position
    const minTop = 10; // Minimum top position
    const maxLeft = window.innerWidth - videoWidth - 10; // Maximum left position
    const maxTop = window.innerHeight - videoHeight - 10; // Maximum top position
    
    // Apply boundaries
    newLeft = Math.min(Math.max(minLeft, newLeft), maxLeft);
    newTop = Math.min(Math.max(minTop, newTop), maxTop);
    
    // Apply position
    videoElement.style.position = 'fixed';
    videoElement.style.left = newLeft + 'px';
    videoElement.style.top = newTop + 'px';
    videoElement.style.right = 'auto';
    videoElement.style.bottom = 'auto';
    videoElement.style.zIndex = '1000';
    
    // Remove any transform that might interfere with positioning
    videoElement.style.transform = 'none';
}

function handleVideoTouchEnd(event) {
    event.preventDefault();
    event.stopPropagation();
    
    // Check for double tap
    if (videoElement && isDragging) {
        const touch = event.changedTouches[0];
        const touchEndTime = new Date().getTime();
        const lastTap = videoElement.dataset.lastTap || 0;
        
        if (touchEndTime - lastTap < 300) {
            // Double tap detected
            toggleLocalVideoSize();
        }
        
        videoElement.dataset.lastTap = touchEndTime;
    }
    
    isDragging = false;
    videoElement = null;
}

// Enhanced toggle function for double-click/tap
function toggleLocalVideoSize() {
    const localVideo = document.getElementById('local-video');
    
    // Check if it's enlarged or default
    if (localVideo.classList.contains('enlarged')) {
        // Return to default
        localVideo.classList.remove('enlarged');
        localVideo.style.width = '80px';
        localVideo.style.height = '120px';
        localVideo.style.bottom = '20px';
        localVideo.style.right = '20px';
        localVideo.style.top = 'auto';
        localVideo.style.left = 'auto';
        localVideo.style.transform = 'none';
    } else {
        // Enlarge
        localVideo.classList.add('enlarged');
        localVideo.style.width = '160px';
        localVideo.style.height = '240px';
        
        // Keep within boundaries after resize
        setTimeout(() => {
            const rect = localVideo.getBoundingClientRect();
            if (rect.right > window.innerWidth - 10) {
                localVideo.style.left = window.innerWidth - rect.width - 10 + 'px';
            }
            if (rect.bottom > window.innerHeight - 10) {
                localVideo.style.top = window.innerHeight - rect.height - 10 + 'px';
            }
        }, 50);
    }
    
    // Haptic feedback for mobile
    if (window.navigator && window.navigator.vibrate) {
        window.navigator.vibrate(20);
    }
}

// Camera switching function
async function switchCamera() {
    if (!localStream) return;
    
    try {
        // Stop current video tracks
        localStream.getVideoTracks().forEach(track => track.stop());
        
        // Toggle camera
        currentCamera = currentCamera === 'user' ? 'environment' : 'user';
        
        // Get new stream with switched camera
        const newStream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: currentCamera },
            audio: true
        });
        
        // Replace video track
        const videoTrack = newStream.getVideoTracks()[0];
        const audioTrack = newStream.getAudioTracks()[0];
        
        // Update local stream
        localStream.removeTrack(localStream.getVideoTracks()[0]);
        localStream.addTrack(videoTrack);
        
        // Update video element
        const localVideo = document.getElementById('local-video');
        localVideo.srcObject = localStream;
        
        // If in a call, replace the track in the peer connection
        if (callState.currentCall && callState.currentCall.peerConnection) {
            const sender = callState.currentCall.peerConnection.getSenders().find(s => s.track.kind === 'video');
            if (sender) {
                sender.replaceTrack(videoTrack);
            }
        }
        
        // Show feedback
        showAlert("Camera Switched", `Now using ${currentCamera === 'user' ? 'front' : 'back'} camera`, "fa-camera");
        
    } catch (err) {
        console.error("Camera switch failed:", err);
        showAlert("Error", "Failed to switch camera");
        // Revert camera state
        currentCamera = currentCamera === 'user' ? 'environment' : 'user';
    }
}

// Add double-click for desktop
function setupVideoEventListeners() {
    const localVideo = document.getElementById('local-video');
    
    // Touch events for mobile
    localVideo.addEventListener('touchstart', handleVideoTouchStart);
    localVideo.addEventListener('touchmove', handleVideoTouchMove);
    localVideo.addEventListener('touchend', handleVideoTouchEnd);
    
    // Double-click for desktop
    localVideo.addEventListener('dblclick', (e) => {
        e.preventDefault();
        toggleLocalVideoSize();
    });
    
    // Mouse drag for desktop (optional)
    let isMouseDown = false;
    let mouseStartX, mouseStartY;
    let mouseStartLeft, mouseStartTop;
    
    localVideo.addEventListener('mousedown', (e) => {
        e.preventDefault();
        isMouseDown = true;
        mouseStartX = e.clientX;
        mouseStartY = e.clientY;
        
        const rect = localVideo.getBoundingClientRect();
        mouseStartLeft = rect.left;
        mouseStartTop = rect.top;
        
        localVideo.style.cursor = 'grabbing';
    });
    
    document.addEventListener('mousemove', (e) => {
        if (!isMouseDown) return;
        e.preventDefault();
        
        const deltaX = e.clientX - mouseStartX;
        const deltaY = e.clientY - mouseStartY;
        
        let newLeft = mouseStartLeft + deltaX;
        let newTop = mouseStartTop + deltaY;
        
        // Apply boundaries
        const minLeft = 10;
        const minTop = 10;
        const maxLeft = window.innerWidth - localVideo.offsetWidth - 10;
        const maxTop = window.innerHeight - localVideo.offsetHeight - 10;
        
        newLeft = Math.min(Math.max(minLeft, newLeft), maxLeft);
        newTop = Math.min(Math.max(minTop, newTop), maxTop);
        
        localVideo.style.position = 'fixed';
        localVideo.style.left = newLeft + 'px';
        localVideo.style.top = newTop + 'px';
        localVideo.style.right = 'auto';
        localVideo.style.bottom = 'auto';
    });
    
    document.addEventListener('mouseup', () => {
        isMouseDown = false;
        localVideo.style.cursor = 'move';
    });
}

// Add camera switch button to call controls
function addCameraSwitchButton() {
    const controlsDiv = document.querySelector('#call-modal .flex.gap-4');
    if (controlsDiv && !document.getElementById('camera-switch-btn')) {
        const switchBtn = document.createElement('button');
        switchBtn.id = 'camera-switch-btn';
        switchBtn.onclick = switchCamera;
        switchBtn.className = 'w-8 h-8 bg-white/10 rounded-full flex items-center justify-center text-2xl text-white/80 hover:bg-white/20 hover:text-white hover:scale-110 transition-all';
        switchBtn.innerHTML = '<i class="fas fa-sync-alt"></i>';
        
        // Insert before fullscreen button
        const fullscreenBtn = document.getElementById('fullscreen-btn');
        if (fullscreenBtn) {
            controlsDiv.insertBefore(switchBtn, fullscreenBtn);
        }
    }
}

// Call this when call modal opens
function showCallModal() {
    document.getElementById('call-modal').style.display = 'flex';
    addCameraSwitchButton();
    setupVideoEventListeners();
}

// Optional: Auto-adjust based on connection quality
function adjustVideoQuality() {
    if ('connection' in navigator) {
        const connection = navigator.connection;
        if (connection.downlink < 1.0) {
            // Poor connection - reduce video size/quality
            const video = document.getElementById('local-video');
            video.style.width = '70px';
            video.style.height = '124px';
        }
    }
}
</script>
</body>
</html>
